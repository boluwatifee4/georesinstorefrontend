<!-- Loading State -->
<div *ngIf="loading()" class="min-h-screen bg-gray-50 flex items-center justify-center">
  <div class="text-center">
    <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
    <p class="text-gray-600">Loading order details...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error() && !loading()" class="min-h-screen bg-gray-50 flex items-center justify-center">
  <div class="text-center">
    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <ng-icon name="lucideTriangleAlert" class="text-red-600 text-2xl"></ng-icon>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Order</h3>
    <p class="text-gray-600 mb-4">{{ error() }}</p>
    <button
      (click)="onBack()"
      class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200"
    >
      <ng-icon name="lucideArrowLeft" class="text-lg"></ng-icon>
      <span>Back to Orders</span>
    </button>
  </div>
</div>

<!-- Order Detail Content -->
<div *ngIf="order() && !loading() && !error()" class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button
            (click)="onBack()"
            class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors duration-200"
          >
            <ng-icon name="lucideArrowLeft" class="text-lg"></ng-icon>
            <span>Back to Orders</span>
          </button>
          <div class="w-px h-6 bg-gray-300"></div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Order {{ order()?.orderCode }}</h1>
            <p class="text-gray-600">Order Details & Management</p>
          </div>
        </div>

        <!-- Status Badge -->
        <span class="inline-flex px-4 py-2 rounded-full text-sm font-semibold {{ getStatusBadgeClass(order()!.status) }}">
          {{ getStatusText(order()!.status) }}
        </span>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Order Information -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Order Items -->
        <div *ngIf="order()?.items?.length" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                <ng-icon name="lucidePackage" class="text-orange-600 text-lg"></ng-icon>
              </div>
              <h2 class="text-lg font-semibold text-gray-900">Items ({{ order()!.items!.length }})</h2>
            </div>
            <span class="text-sm text-gray-500">Subtotal: {{ formatCurrency(order()!.subTotal) }}</span>
          </div>

            <div class="overflow-hidden rounded-xl border border-gray-200">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-gray-50 text-xs uppercase tracking-wide text-gray-600">
                    <th class="px-4 py-3 font-semibold">Item</th>
                    <th class="px-4 py-3 font-semibold">SKU</th>
                    <th class="px-4 py-3 font-semibold text-center">Qty</th>
                    <th class="px-4 py-3 font-semibold text-right">Unit</th>
                    <th class="px-4 py-3 font-semibold text-right">Line Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let it of order()!.items!; let i = index" class="border-t border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div class="font-medium text-gray-900">{{ it.titleSnap || 'Item ' + (i+1) }}</div>
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-sm">{{ it.skuSnap }}</td>
                    <td class="px-4 py-3 text-center font-medium">{{ it.qty }}</td>
                    <td class="px-4 py-3 text-right">{{ formatCurrency(it.unitPriceSnap.toString()) }}</td>
                    <td class="px-4 py-3 text-right font-semibold">{{ formatCurrency(( (+it.unitPriceSnap) * it.qty ).toString()) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <div class="text-sm text-gray-500">
                <span>Manual quote required: </span>
                <span [class.text-green-600]="order()!.needsManualQuote" [class.text-gray-500]="!order()!.needsManualQuote">
                  {{ order()!.needsManualQuote ? 'Yes' : 'No' }}
                </span>
              </div>
              <div *ngIf="order()!.whatsappLink" class="text-right">
                <a 
                  [href]="order()!.whatsappLink" target="_blank" rel="noopener"
                  class="inline-flex items-center gap-2 text-sm text-green-600 hover:text-green-700 font-medium">
                  <ng-icon name="lucidePhone" class="text-base"></ng-icon>
                  Contact via WhatsApp
                </a>
              </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
              <ng-icon name="lucideUser" class="text-blue-600 text-lg"></ng-icon>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Customer Information</h2>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div *ngIf="order()?.buyerName">
              <label class="block text-sm font-medium text-gray-500 mb-1">Full Name</label>
              <p class="text-gray-900">{{ order()?.buyerName }}</p>
            </div>

            <div *ngIf="order()?.email">
              <label class="block text-sm font-medium text-gray-500 mb-1">Email</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucideMail" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ order()?.email }}</p>
              </div>
            </div>

            <div *ngIf="order()?.phone">
              <label class="block text-sm font-medium text-gray-500 mb-1">Phone</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucidePhone" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ order()?.phone }}</p>
              </div>
            </div>

            <div *ngIf="order()?.whatsapp">
              <label class="block text-sm font-medium text-gray-500 mb-1">WhatsApp</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucidePhone" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ order()?.whatsapp }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery Information -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
              <ng-icon name="lucideMapPin" class="text-green-600 text-lg"></ng-icon>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Delivery Information</h2>
          </div>

          <div class="space-y-4">
            <div *ngIf="order()?.locationLabel">
              <label class="block text-sm font-medium text-gray-500 mb-1">Delivery Address</label>
              <p class="text-gray-900">{{ order()?.locationLabel }}</p>
            </div>

            <div *ngIf="order()?.deliveryZoneName">
              <label class="block text-sm font-medium text-gray-500 mb-1">Delivery Zone</label>
              <p class="text-gray-900">{{ order()?.deliveryZoneName }}</p>
            </div>

            <div *ngIf="order()?.needsManualQuote">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center gap-2">
                  <ng-icon name="lucideTriangleAlert" class="text-yellow-600 text-lg"></ng-icon>
                  <p class="text-yellow-800 font-medium">Manual quote required for this delivery</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div *ngIf="order()?.status === 'DECLARED_PAID' || order()?.declaredAt" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
              <ng-icon name="lucideBanknote" class="text-purple-600 text-lg"></ng-icon>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Payment Information</h2>
          </div>

          <div class="space-y-4">
            <div *ngIf="order()?.bankName">
              <label class="block text-sm font-medium text-gray-500 mb-1">Bank Name</label>
              <p class="text-gray-900">{{ order()?.bankName }}</p>
            </div>

            <div *ngIf="order()?.accountNumber">
              <label class="block text-sm font-medium text-gray-500 mb-1">Account Number</label>
              <p class="text-gray-900">{{ order()?.accountNumber }}</p>
            </div>

            <div *ngIf="order()?.declaredAt">
              <label class="block text-sm font-medium text-gray-500 mb-1">Payment Declared At</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucideCalendar" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ formatDate(order()!.declaredAt!) }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Rejection Information -->
        <div *ngIf="order()?.status === 'REJECTED' && order()?.rejectReason" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
              <ng-icon name="lucideX" class="text-red-600 text-lg"></ng-icon>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Rejection Information</h2>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-500 mb-1">Reason</label>
            <p class="text-gray-900">{{ order()?.rejectReason }}</p>
          </div>
        </div>
      </div>

      <!-- Order Summary & Actions -->
      <div class="space-y-6">
        <!-- Order Summary -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
              <ng-icon name="lucidePackage" class="text-orange-600 text-lg"></ng-icon>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Order Summary</h2>
          </div>

          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Subtotal:</span>
              <span class="font-medium text-gray-900">{{ formatCurrency(order()?.subTotal) }}</span>
            </div>

            <div class="flex justify-between items-center">
              <span class="text-gray-600">Delivery Fee:</span>
              <span class="font-medium text-gray-900">{{ formatCurrency(order()?.deliveryFee) }}</span>
            </div>

            <div class="border-t border-gray-200 pt-4">
              <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-900">Total:</span>
                <span class="text-lg font-semibold text-gray-900">{{ formatCurrency(order()?.total) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Metadata -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
              <ng-icon name="lucideClock" class="text-gray-600 text-lg"></ng-icon>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Order Timeline</h2>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Created At</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucideCalendar" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ formatDate(order()!.createdAt) }}</p>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Last Updated</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucideCalendar" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ formatDate(order()!.updatedAt) }}</p>
              </div>
            </div>

            <div *ngIf="order()?.reviewedAt">
              <label class="block text-sm font-medium text-gray-500 mb-1">Reviewed At</label>
              <div class="flex items-center gap-2">
                <ng-icon name="lucideCalendar" class="text-gray-400 text-sm"></ng-icon>
                <p class="text-gray-900">{{ formatDate(order()!.reviewedAt!) }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>

          <div class="space-y-3">
            <!-- Set Under Review -->
            <button
              *ngIf="canSetUnderReview()"
              (click)="onSetUnderReview()"
              [disabled]="actionLoading()"
              class="w-full inline-flex items-center justify-center gap-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-yellow-400 text-white px-4 py-3 rounded-xl font-medium transition-all duration-200"
            >
              <ng-icon name="lucideEye" class="text-lg"></ng-icon>
              <span>{{ actionLoading() ? 'Processing...' : 'Set Under Review' }}</span>
            </button>

            <!-- Confirm Order -->
            <button
              *ngIf="canConfirm()"
              (click)="onConfirmOrder()"
              [disabled]="actionLoading()"
              class="w-full inline-flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white px-4 py-3 rounded-xl font-medium transition-all duration-200"
            >
              <ng-icon name="lucideCheck" class="text-lg"></ng-icon>
              <span>{{ actionLoading() ? 'Processing...' : 'Confirm Order' }}</span>
            </button>

            <!-- Reject Order -->
            <button
              *ngIf="canReject()"
              (click)="onRejectOrder()"
              [disabled]="actionLoading()"
              class="w-full inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 disabled:bg-red-400 text-white px-4 py-3 rounded-xl font-medium transition-all duration-200"
            >
              <ng-icon name="lucideX" class="text-lg"></ng-icon>
              <span>{{ actionLoading() ? 'Processing...' : 'Reject Order' }}</span>
            </button>

            <!-- No actions available -->
            <div *ngIf="!canSetUnderReview() && !canConfirm() && !canReject()" class="text-center py-4">
              <p class="text-gray-500">No actions available for this order status</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
